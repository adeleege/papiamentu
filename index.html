<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Woorden oefenen</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#fafafa;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#eff6ff;
      --radius:14px;
      --shadow:0 1px 2px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text)
    }
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:8px;margin:10px 0 14px;flex-wrap:wrap}
    .tab{
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      font-weight:600;
      box-shadow:var(--shadow);
      user-select:none
    }
    .tab.active{background:var(--accent-soft);border-color:rgba(37,99,235,.4)}
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:600;
      cursor:pointer
    }
    button.primary{background:var(--accent-soft);border-color:rgba(37,99,235,.4)}
    button:disabled{opacity:.55;cursor:not-allowed}
    input{padding:10px 12px;border-radius:12px;border:1px solid var(--border)}
    .list{
      max-height:62vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:8px;
      background:#fff
    }
    .item{padding:10px}
    .item + .item{border-top:1px solid #f3f4f6}
    .pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff}
    .chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      background:#fff
    }
    .chip input{margin:0}
    .opt{width:100%;text-align:left}

    .ok{
      border-color: rgba(22,163,74,.55) !important;
      background: rgba(22,163,74,.10) !important;
    }
    .bad{
      border-color: rgba(220,38,38,.55) !important;
      background: rgba(220,38,38,.10) !important;
    }

    .section-title{margin-top:10px}

    #splash{
      position:fixed;inset:0;background:#f9fafb;
      display:flex;align-items:center;justify-content:center;
      z-index:9999
    }
    .splash-card{text-align:center}
    .splash-title{font-size:28px;font-weight:700}
    .splash-sub{color:#6b7280;margin-top:4px}
    .loader{
      width:36px;height:36px;border:3px solid #e5e7eb;
      border-top-color:#2563eb;border-radius:50%;
      animation:spin 1s linear infinite;margin:16px auto 0
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== Learning + Quiz UI boost ===== */
    #learnFront, #quizQuestion { font-size: 1.25rem; line-height: 1.4; }
    #learnBack { font-size: 1.15rem; }

    #quizOptions button,
    #learnRevealBtn, #learnNextBtn,
    #quizNextBtn, #quizSkipBtn {
      font-size: 1.05rem;
      padding: 12px 14px;
      margin-top: 6px;
    }

    /* Grotere leerkaart */
    #learnCard { padding: 18px; }

    /* Subtiele animaties */
    @keyframes pop {
      0% { transform: scale(1); }
      40% { transform: scale(1.015); }
      100% { transform: scale(1); }
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-4px); }
      40% { transform: translateX(4px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
      100% { transform: translateX(0); }
    }
    .pulse-ok { animation: pop 220ms ease-out; }
    .shake-bad { animation: shake 260ms ease-in-out; }

    @media (max-width: 480px) {
      #learnFront, #quizQuestion { font-size: 1.3rem; }
      #quizOptions button, #learnRevealBtn, #learnNextBtn { font-size: 1.1rem; padding: 14px; }
    }
  </style>
</head>

<body>
  <div id="splash">
    <div class="splash-card">
      <div class="splash-title">Papiamentu</div>
      <div class="splash-sub">Woorden oefenen</div>
      <div class="loader"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="muted" id="status"></div>

    <div class="tabs">
      <div id="tabOverview" class="tab active">Woordenlijst</div>
      <div id="tabLearn" class="tab">Oefenen</div>
      <div id="tabQuiz" class="tab">Test jezelf</div>
    </div>

    <!-- OVERVIEW -->
    <div id="overviewShell">
      <div class="card">
        <div class="row">
          <strong>Filters</strong>
          <button id="selAllBtn">Alles</button>
          <button id="selNoneBtn">Niets</button>
          <button id="resetFiltersBtn">Reset</button>
        </div>

        <div class="section-title"><strong>Woordsoort</strong></div>
        <div id="posChecks" class="row" style="margin-top:8px"></div>

        <div class="section-title"><strong>Tags</strong> <span class="muted">(leeg = geen tag)</span></div>
        <div id="tagChecks" class="row" style="margin-top:8px"></div>

        <div class="row" style="margin-top:12px">
          <strong>Les</strong>
          <span class="muted">van</span>
          <input id="lessonFrom" type="number" min="1" step="1" style="width:90px" />
          <span class="muted">tot</span>
          <input id="lessonTo" type="number" min="1" step="1" style="width:90px" />
          <button id="sortAZBtn">Sorteren A–Z</button>
        </div>

        <div class="muted" style="margin-top:8px">
          Filters gelden voor Woordenlijst, Oefenen en Test jezelf.
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Woorden (NL ↔ PAP)</strong>
          <span class="muted">max 200</span>
        </div>
        <div id="pairs" class="list" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- LEARN -->
    <div id="learnShell" style="display:none">
      <div class="card" id="learnCard" style="display:none">
        <div class="muted" id="learnMeta"></div>
        <h3 id="learnFront" style="margin:10px 0 0"></h3>
        <div id="learnBack" style="display:none;margin-top:10px"></div>

        <div style="margin-top:12px">
          <button id="learnRevealBtn" class="primary">Toon antwoord</button>
          <button id="learnNextBtn">Volgende</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Tip: swipe <b>rechts</b> = antwoord • swipe <b>links</b> = volgende
        </div>
      </div>

      <div class="card" id="learnEmpty" style="display:none">
        <strong>Geen woorden in deze selectie</strong>
        <div class="muted" style="margin-top:6px">Pas filters aan in Woordenlijst.</div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quizShell" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Quiz</strong>
          <div class="row">
            <span class="pill"><span id="quizCorrect">0</span>/<span id="quizTotal">0</span></span>
            <span class="pill"><span id="quizPct">0%</span></span>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="quizResetBtn">Reset score</button>
        </div>
        <div class="muted" style="margin-top:8px">(Score is lokaal op dit apparaat.)</div>
      </div>

      <div class="card" id="quizCard" style="display:none">
        <div class="muted" id="quizMeta"></div>
        <h3 id="quizQuestion" style="margin:10px 0 0"></h3>
        <div id="quizOptions" style="margin-top:10px"></div>
        <div id="quizFeedback" style="margin-top:10px"></div>

        <div style="margin-top:12px">
          <button id="quizNextBtn" class="primary" style="display:none">Volgende</button>
          <button id="quizSkipBtn">Sla over</button>
        </div>
      </div>

      <div class="card" id="quizEmpty" style="display:none">
        <strong>Geen quizvragen beschikbaar</strong>
        <div class="muted" style="margin-top:6px">Zorg dat er minstens 2 woorden in je selectie zitten.</div>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxlXU7l80EPIpJJwRam1s9CdbH8PQ_PvQyftwTq55Qk51qkorrnBjwKXu2dxAp-Np_4/exec";
  const LS_KEY = "papiamentu_app_v4";

  let rawCards = [];
  let cards = [];
  let learnCurrent = null;
  let quizCurrent = null;
  let quizLocked = false;

  // Local state + defaults
  let state = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
  if (!Array.isArray(state.pos)) state.pos = [];          // empty => all
  if (!Array.isArray(state.tags)) state.tags = [];        // empty => all
  if (state.sortAZ === undefined) state.sortAZ = false;
  if (!state.quiz) state.quiz = { correct: 0, total: 0 };
  if (!state.activeTab) state.activeTab = "overview";
  if (state.lessonFrom === undefined || state.lessonFrom === null || state.lessonFrom === "" || Number.isNaN(Number(state.lessonFrom))) state.lessonFrom = 1;
  if (state.lessonTo === undefined || state.lessonTo === null || state.lessonTo === "" || Number.isNaN(Number(state.lessonTo))) state.lessonTo = 1;
  save();

  const POS_LABELS = {
    noun:"Zelfst. nw", verb:"Werkwoord", adj:"Bijv. nw",
    adv:"Bijwoord", prep:"Voorzetsel", pron:"Voornaamw.",
    conj:"Voegwoord", phrase:"Uitdrukking", other:"Overig"
  };
  const POS_ORDER = ["noun","verb","adj","adv","prep","pron","conj","phrase","other"];
  const UNTAGGED = "__UNTAGGED__";

  const el = (id) => document.getElementById(id);
  const norm = (s) => String(s || "").trim().toLowerCase();

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function setStatus(msg){ el("status").textContent = msg || ""; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function bump(elm, cls){
    if (!elm) return;
    elm.classList.remove(cls);
    void elm.offsetWidth; // reflow to retrigger animation
    elm.classList.add(cls);
    setTimeout(() => elm.classList.remove(cls), 350);
  }

  function lessonOf(card){
    const n = Number(card.due ?? 1);
    return Number.isFinite(n) && n >= 1 ? Math.floor(n) : 1;
  }

  function parseTags(raw){
    const s = String(raw ?? "").trim();
    if (!s) return [];
    return s.split(/[;,]/g).map(t => t.trim()).filter(Boolean);
  }

  function mergedCard(raw){
    return {
      ...raw,
      id: String(raw.id ?? raw.ID ?? raw.Id ?? (raw.front + "||" + raw.back)),
      pos: norm(raw.pos) || "other",
      front: String(raw.front ?? ""),
      back: String(raw.back ?? ""),
      due: raw.due,
      active: String(raw.active ?? "TRUE").toUpperCase() !== "FALSE",
      tags: parseTags(raw.tags ?? raw.tag ?? "")
    };
  }

  function allTypes(){
    const types = new Set(cards.map(c => c.pos || "other"));
    return Array.from(types).sort((a,b) => (POS_ORDER.indexOf(a) - POS_ORDER.indexOf(b)));
  }

  function allTags(){
    const set = new Set();
    let hasUntagged = false;
    cards.forEach(c => {
      const ts = (c.tags || []);
      if (!ts.length) hasUntagged = true;
      ts.forEach(t => set.add(t));
    });
    const list = Array.from(set).sort((a,b) => a.localeCompare(b, "nl", {sensitivity:"base"}));
    if (hasUntagged) list.unshift(UNTAGGED);
    return list;
  }

  function selectedPosSet(){
    if (!state.pos || state.pos.length === 0) return new Set(allTypes());
    return new Set(state.pos.map(norm));
  }

  function selectedTagSet(){
    if (!state.tags || state.tags.length === 0) return null; // null => all tags allowed
    return new Set(state.tags);
  }

  function inLessonRange(card){
    const l = lessonOf(card);
    const from = Math.max(1, Math.floor(Number(state.lessonFrom || 1)));
    const to = Math.max(from, Math.floor(Number(state.lessonTo || from)));
    return l >= from && l <= to;
  }

  function matchesTags(card){
    const sel = selectedTagSet();
    if (!sel) return true;

    const ts = card.tags || [];
    if (!ts.length) return sel.has(UNTAGGED);
    return ts.some(t => sel.has(t));
  }

  function filteredPool(){
    const posSel = selectedPosSet();

    return cards.filter(c => {
      if (!c.active) return false;
      if (!inLessonRange(c)) return false;
      if (!posSel.has(norm(c.pos))) return false;
      if (!matchesTags(c)) return false;
      return (c.front || "").trim() && (c.back || "").trim();
    });
  }

  function renderPosChecks(){
    const cont = el("posChecks");
    cont.innerHTML = "";

    const types = allTypes();
    const sel = selectedPosSet();

    types.forEach(p => {
      const lab = document.createElement("label");
      lab.className = "chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = sel.has(p);
      cb.onchange = () => {
        if (!state.pos || state.pos.length === 0) state.pos = types.slice();

        if (cb.checked) {
          if (!state.pos.includes(p)) state.pos.push(p);
        } else {
          state.pos = state.pos.filter(x => x !== p);
        }

        if (state.pos.length === types.length) state.pos = [];
        save();
        refreshAllViews();
      };

      const txt = document.createElement("span");
      txt.textContent = POS_LABELS[p] || p;

      lab.appendChild(cb);
      lab.appendChild(txt);
      cont.appendChild(lab);
    });
  }

  function renderTagChecks(){
    const cont = el("tagChecks");
    cont.innerHTML = "";

    const tags = allTags();
    const sel = selectedTagSet(); // null => all

    if (tags.length === 0){
      cont.innerHTML = `<div class="muted">Geen tags gevonden.</div>`;
      return;
    }

    tags.forEach(t => {
      const lab = document.createElement("label");
      lab.className = "chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = sel ? sel.has(t) : true;

      cb.onchange = () => {
        if (!state.tags || state.tags.length === 0) state.tags = tags.slice();

        if (cb.checked) {
          if (!state.tags.includes(t)) state.tags.push(t);
        } else {
          state.tags = state.tags.filter(x => x !== t);
        }

        if (state.tags.length === tags.length) state.tags = [];
        save();
        refreshAllViews();
      };

      const txt = document.createElement("span");
      txt.textContent = (t === UNTAGGED) ? "Geen tag" : t;

      lab.appendChild(cb);
      lab.appendChild(txt);
      cont.appendChild(lab);
    });
  }

  function updateSortButtonLabel(){
    el("sortAZBtn").textContent = state.sortAZ ? "Sorteren: standaard" : "Sorteren A–Z";
  }

  function renderPairs(){
    const box = el("pairs");
    box.innerHTML = "";

    let arr = filteredPool();

    if (!arr.length){
      box.innerHTML = `<div class="muted" style="padding:10px">Geen woorden binnen je filters.</div>`;
      return;
    }

    if (state.sortAZ){
      arr.sort((a,b)=>a.front.localeCompare(b.front, "nl", {sensitivity:"base"}));
    } else {
      arr.sort((a,b)=>{
        const pa = POS_ORDER.indexOf(norm(a.pos));
        const pb = POS_ORDER.indexOf(norm(b.pos));
        if (pa !== pb) return pa - pb;
        const la = lessonOf(a), lb = lessonOf(b);
        if (la !== lb) return la - lb;
        return a.front.localeCompare(b.front, "nl", {sensitivity:"base"});
      });
    }

    arr.slice(0, 200).forEach(c => {
      const div = document.createElement("div");
      div.className = "item";
      const tagText = (c.tags && c.tags.length) ? c.tags.join(", ") : "—";
      div.innerHTML = `
        <div class="muted">${(POS_LABELS[norm(c.pos)] || c.pos)} • les ${lessonOf(c)} • tags: ${escapeHtml(tagText)}</div>
        <div><b>${escapeHtml(c.front)}</b> ↔ ${escapeHtml(c.back)}</div>
      `;
      box.appendChild(div);
    });
  }

  // ===== Learn =====
  function showLearnCard(c){
    learnCurrent = c;

    el("learnEmpty").style.display = "none";
    el("learnCard").style.display = "block";
    el("learnFront").textContent = c.front || "";
    el("learnBack").textContent = c.back || "";
    el("learnBack").style.display = "none";
    el("learnRevealBtn").style.display = "inline-block";

    const tagText = (c.tags && c.tags.length) ? c.tags.join(", ") : "—";
    el("learnMeta").textContent = `Type: ${c.pos || "-"} • les: ${lessonOf(c)} • tags: ${tagText}`;
  }

  function showLearnEmpty(){
    learnCurrent = null;
    el("learnCard").style.display = "none";
    el("learnEmpty").style.display = "block";
  }

  function showNextLearn(){
    const pool = filteredPool();
    if (!pool.length) return showLearnEmpty();
    const nxt = pool[Math.floor(Math.random() * pool.length)];
    showLearnCard(nxt);
  }

  function revealLearn(){
    el("learnBack").style.display = "block";
    el("learnRevealBtn").style.display = "none";
  }

  // ===== Quiz =====
  function renderQuizStats(){
    const s = state.quiz || { correct: 0, total: 0 };
    el("quizCorrect").textContent = String(s.correct || 0);
    el("quizTotal").textContent = String(s.total || 0);
    const pct = (s.total > 0) ? Math.round((s.correct / s.total) * 100) : 0;
    el("quizPct").textContent = `${pct}%`;
  }

  function uniq(arr){ return Array.from(new Set(arr)); }
  function shuffle(a){
    const arr = a.slice();
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function makeQuizQuestion(){
    const pool = filteredPool();
    if (pool.length < 2) return null;

    const correct = pool[Math.floor(Math.random() * pool.length)];
    const others = pool.filter(c => c.id !== correct.id);

    const samePos = others.filter(c => norm(c.pos) === norm(correct.pos));
    const decoyPool = (samePos.length >= 3 ? samePos : others);

    const decoys = shuffle(decoyPool).map(c => c.back).filter(b => b && b !== correct.back);
    const options = uniq([correct.back, ...decoys]).slice(0, 4);

    if (options.length < 2) return null;
    return { correct, options: shuffle(options) };
  }

  function renderQuiz(q){
    quizCurrent = q;
    quizLocked = false;

    el("quizEmpty").style.display = "none";
    el("quizCard").style.display = "block";
    el("quizFeedback").innerHTML = "";
    el("quizNextBtn").style.display = "none";

    const tagText = (q.correct.tags && q.correct.tags.length) ? q.correct.tags.join(", ") : "—";
    el("quizMeta").textContent = `Type: ${q.correct.pos || "-"} • les: ${lessonOf(q.correct)} • tags: ${tagText}`;
    el("quizQuestion").textContent = q.correct.front || "";

    const cont = el("quizOptions");
    cont.innerHTML = "";

    q.options.forEach(opt => {
      const b = document.createElement("button");
      b.className = "opt";
      b.textContent = opt;
      b.onclick = () => onQuizAnswer(opt);
      cont.appendChild(b);
    });
  }

  function showQuizEmpty(){
    quizCurrent = null;
    el("quizCard").style.display = "none";
    el("quizEmpty").style.display = "block";
  }

  function showNextQuiz(force=false){
    if (!force && quizLocked) return;
    const q = makeQuizQuestion();
    if (!q) return showQuizEmpty();
    renderQuiz(q);
  }

  function onQuizAnswer(selected){
    if (!quizCurrent || quizLocked) return;

    const { correct } = quizCurrent;
    const buttons = Array.from(el("quizOptions").querySelectorAll("button"));
    buttons.forEach(b => b.disabled = true);

    state.quiz = state.quiz || { correct: 0, total: 0 };
    state.quiz.total = (state.quiz.total || 0) + 1;

    if (selected === correct.back){
      state.quiz.correct = (state.quiz.correct || 0) + 1;
      save();
      renderQuizStats();

      buttons.forEach(b => { if (b.textContent === correct.back) b.classList.add("ok"); });
      el("quizFeedback").innerHTML = `<div class="muted">✅ Goed!</div>`;
      bump(el("quizCard"), "pulse-ok");

      setTimeout(() => showNextQuiz(true), 350);
    } else {
      save();
      renderQuizStats();

      quizLocked = true;
      buttons.forEach(b => {
        if (b.textContent === selected) b.classList.add("bad");
        if (b.textContent === correct.back) b.classList.add("ok"); // highlight correct
      });

      el("quizFeedback").innerHTML =
        `<div class="muted">❌ Fout. Juiste antwoord: <b>${escapeHtml(correct.back)}</b></div>`;
      el("quizNextBtn").style.display = "inline-block";
      bump(el("quizCard"), "shake-bad");
    }
  }

  // ===== Tabs =====
  function activateTab(name){
    const isOverview = name === "overview";
    const isLearn = name === "learn";
    const isQuiz = name === "quiz";

    el("tabOverview").classList.toggle("active", isOverview);
    el("tabLearn").classList.toggle("active", isLearn);
    el("tabQuiz").classList.toggle("active", isQuiz);

    el("overviewShell").style.display = isOverview ? "block" : "none";
    el("learnShell").style.display = isLearn ? "block" : "none";
    el("quizShell").style.display = isQuiz ? "block" : "none";

    state.activeTab = name;
    save();

    if (isOverview) renderPairs();
    if (isLearn) showNextLearn();
    if (isQuiz) { renderQuizStats(); showNextQuiz(true); }
  }

  function refreshAllViews(){
    renderPairs();
    if (el("learnShell").style.display !== "none") showNextLearn();
    if (el("quizShell").style.display !== "none") showNextQuiz(true);
  }

  // ===== Events =====
  el("tabOverview").onclick = () => activateTab("overview");
  el("tabLearn").onclick = () => activateTab("learn");
  el("tabQuiz").onclick = () => activateTab("quiz");

  el("sortAZBtn").onclick = () => {
    state.sortAZ = !state.sortAZ;
    save();
    updateSortButtonLabel();
    renderPairs();
  };

  el("learnRevealBtn").onclick = () => {
    revealLearn();
    bump(el("learnCard"), "pulse-ok");
  };
  el("learnNextBtn").onclick = () => {
    showNextLearn();
    bump(el("learnCard"), "pulse-ok");
  };

  // Swipe on learn card: right=reveal, left=next
  (function enableLearnSwipe(){
    const card = document.getElementById("learnCard");
    if (!card) return;

    let x0 = null, y0 = null, t0 = 0;

    card.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      x0 = t.clientX;
      y0 = t.clientY;
      t0 = Date.now();
    }, { passive: true });

    card.addEventListener("touchend", (e) => {
      if (x0 === null || y0 === null) return;

      const t = e.changedTouches[0];
      const dx = t.clientX - x0;
      const dy = t.clientY - y0;
      const dt = Date.now() - t0;

      x0 = y0 = null;

      if (dt > 800) return;
      if (Math.abs(dx) < 45 || Math.abs(dx) < Math.abs(dy)) return;

      if (dx > 0) {
        // right: reveal (only if hidden)
        const back = document.getElementById("learnBack");
        if (back && back.style.display === "none") {
          revealLearn();
        }
        bump(document.getElementById("learnCard"), "pulse-ok");
      } else {
        // left: next
        showNextLearn();
        bump(document.getElementById("learnCard"), "pulse-ok");
      }
    }, { passive: true });
  })();

  el("quizResetBtn").onclick = () => {
    state.quiz = { correct: 0, total: 0 };
    save();
    renderQuizStats();
    quizLocked = false;
    showNextQuiz(true);
  };
  el("quizNextBtn").onclick = () => { quizLocked = false; showNextQuiz(true); };
  el("quizSkipBtn").onclick = () => showNextQuiz(true);

  el("selAllBtn").onclick = () => {
    state.pos = [];
    state.tags = [];
    save();
    renderPosChecks();
    renderTagChecks();
    refreshAllViews();
  };

  el("selNoneBtn").onclick = () => {
    // select nothing in both
    state.pos = ["__NONE_POS__"];
    state.tags = ["__NONE_TAG__"];
    save();
    renderPosChecks();
    renderTagChecks();
    refreshAllViews();
  };

  el("resetFiltersBtn").onclick = () => {
    state.pos = [];
    state.tags = [];
    state.sortAZ = false;

    state.lessonFrom = 1;
    state.lessonTo = (window.__maxLesson || 1);

    save();
    syncLessonInputs();
    renderPosChecks();
    renderTagChecks();
    updateSortButtonLabel();
    refreshAllViews();
  };

  el("lessonFrom").addEventListener("change", () => {
    const v = Math.max(1, Math.floor(Number(el("lessonFrom").value) || 1));
    state.lessonFrom = v;
    if (Number(state.lessonTo) < v) state.lessonTo = v;
    save();
    syncLessonInputs();
    refreshAllViews();
  });

  el("lessonTo").addEventListener("change", () => {
    const v = Math.max(1, Math.floor(Number(el("lessonTo").value) || 1));
    const from = Math.max(1, Math.floor(Number(state.lessonFrom || 1)));
    state.lessonTo = Math.max(from, v);
    save();
    syncLessonInputs();
    refreshAllViews();
  });

  function syncLessonInputs(){
    el("lessonFrom").value = String(Math.max(1, Number(state.lessonFrom || 1)));
    el("lessonTo").value = String(Math.max(1, Number(state.lessonTo || state.lessonFrom || 1)));
  }

  // ===== Load =====
  async function loadFromSheet(){
    setStatus("Loading…");
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      rawCards = (json.data || []).slice();
      cards = rawCards.map(mergedCard).filter(c => c.active);

      const lessons = cards.map(lessonOf);
      const minLesson = lessons.length ? Math.min(...lessons) : 1;
      const maxLesson = lessons.length ? Math.max(...lessons) : 1;
      window.__maxLesson = maxLesson;

      if (!Number.isFinite(Number(state.lessonFrom)) || Number(state.lessonFrom) < minLesson) state.lessonFrom = minLesson;
      if (!Number.isFinite(Number(state.lessonTo)) || Number(state.lessonTo) < state.lessonFrom) state.lessonTo = maxLesson;
      if (Number(state.lessonTo) > maxLesson) state.lessonTo = maxLesson;

      save();
      syncLessonInputs();

      renderPosChecks();
      renderTagChecks();
      updateSortButtonLabel();
      renderPairs();
      renderQuizStats();

      setStatus(`Loaded: ${cards.length} woorden`);
      el("splash").style.display = "none";
      activateTab(state.activeTab || "overview");
    } catch (e){
      console.error(e);
      setStatus("Load mislukt (check Apps Script deployment)");
      el("splash").style.display = "none";
    }
  }

  // Set inputs immediately (even before data arrives)
  syncLessonInputs();
  updateSortButtonLabel();
  renderQuizStats();

  // Register Service Worker (ensure sw.js exists next to index.html)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(err => {
        console.warn("SW registration failed:", err);
      });
    });
  }

  loadFromSheet();
</script>
</body>
</html>





